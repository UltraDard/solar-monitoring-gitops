apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-alert-rules
  namespace: default
  labels:
    name: prometheus-alert-rules
data:
  rules.yaml: |-
    groups:
    - name: solar_alerts
      rules:
      - alert: SolarPanelOverheating
        expr: solar_panel_temperature_celsius > 65
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "Panneau en surchauffe"
          description: "Le panneau {{ $labels.panel_id }} de la ferme {{ $labels.farm }} dépasse 65°C"

      - alert: InverterDown
        expr: solar_inverter_status == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Onduleur HS"
          description: "L'onduleur {{ $labels.inverter_id }} est en panne"

      - alert: LowProduction
        expr: (solar_power_watts / (scalar(solar_irradiance_wm2) * 0.4)) < 0.5 and solar_irradiance_wm2 > 50
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Production basse"
          description: "La production est anormalement faible par rapport à l'ensoleillement"

      - alert: SensorDataLoss
        expr: absent(solar_power_watts)
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Perte de données"
          description: "Aucune donnée reçue depuis 5 minutes"

      - alert: SLOBreach
        expr: avg_over_time(solar_inverter_status[1h]) < 0.995
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "SLO Non respecté"
          description: "Disponibilité inférieure à 99.5%"
